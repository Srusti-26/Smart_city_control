<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart City Control Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&amp;family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Space Grotesk', sans-serif;
    }
    .mono { font-family: 'JetBrains Mono', monospace; }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 5px currentColor; }
      50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }
    
    @keyframes data-flow {
      0% { transform: translateX(-100%); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateX(100%); opacity: 0; }
    }
    
    @keyframes scan-line {
      0% { top: 0; }
      100% { top: 100%; }
    }
    
    .alert-critical { animation: pulse-glow 1s ease-in-out infinite; color: #ef4444; }
    .alert-warning { animation: pulse-glow 2s ease-in-out infinite; color: #f59e0b; }
    
    .data-stream::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, #00ff88, transparent);
      animation: data-flow 2s linear infinite;
    }
    
    .grid-pattern {
      background-image: 
        linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
      background-size: 20px 20px;
    }
    
    .scan-effect::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(0, 255, 136, 0.5), transparent);
      animation: scan-line 3s linear infinite;
    }
    
    .agent-card {
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 255, 136, 0.2);
      transition: all 0.3s ease;
    }
    
    .agent-card:hover {
      border-color: rgba(0, 255, 136, 0.5);
      transform: translateY(-2px);
    }
    
    .metric-value {
      background: linear-gradient(135deg, #00ff88 0%, #00d4ff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .chat-message {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .compression-bar {
      background: linear-gradient(90deg, #00ff88, #00d4ff);
      transition: width 0.5s ease-out;
    }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #00ff8855; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #00ff88; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-[#0a0a0a] text-gray-100 overflow-hidden">
  <div id="app" class="h-full flex flex-col"><!-- Header -->
   <header class="flex-shrink-0 border-b border-[#00ff88]/20 bg-[#0a0a0a]/95 backdrop-blur-sm">
    <div class="flex items-center justify-between px-6 py-3">
     <div class="flex items-center gap-4">
      <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex items-center justify-center">
       <svg class="w-6 h-6 text-[#0a0a0a]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
       </svg>
      </div>
      <div>
       <h1 id="dashboard-title" class="text-xl font-bold tracking-tight">Smart City Control Center</h1>
       <p id="city-name" class="text-xs text-[#00ff88]/70 mono">METROPOLIS DIGITAL TWIN</p>
      </div>
     </div>
     <div class="flex items-center gap-6"><!-- System Status -->
      <div class="flex items-center gap-2">
       <div class="w-2 h-2 rounded-full bg-[#00ff88] animate-pulse"></div><span class="text-xs mono text-gray-400">SYSTEM ONLINE</span>
      </div><!-- Time -->
      <div class="text-right">
       <div id="current-time" class="text-lg font-bold mono text-[#00ff88]">
        --:--:--
       </div>
       <div id="current-date" class="text-xs text-gray-500 mono">
        ----/--/--
       </div>
      </div><!-- Voice Control Toggle --> <button id="voice-toggle" class="p-2 rounded-lg border border-[#00ff88]/30 hover:border-[#00ff88] hover:bg-[#00ff88]/10 transition-all group">
       <svg class="w-5 h-5 text-gray-400 group-hover:text-[#00ff88]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
       </svg></button>
     </div>
    </div><!-- Navigation Tabs -->
    <div class="flex px-6 gap-1"><button class="nav-tab active px-4 py-2 text-sm font-medium border-b-2 border-[#00ff88] text-[#00ff88]" data-tab="dashboard">Dashboard</button> <button class="nav-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-200" data-tab="agents">Agents</button> <button class="nav-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-200" data-tab="compression">ScaleDown</button> <button class="nav-tab px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-200" data-tab="chat">Chat</button>
    </div>
   </header><!-- Main Content -->
   <main class="flex-1 overflow-auto grid-pattern"><!-- Dashboard Tab -->
    <div id="tab-dashboard" class="tab-content h-full p-6">
     <div class="grid grid-cols-12 gap-4 h-full"><!-- Left Column - KPIs -->
      <div class="col-span-3 flex flex-col gap-4"><!-- Traffic KPI -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4 relative overflow-hidden">
        <div class="flex items-center justify-between mb-3"><span class="text-xs text-gray-400 uppercase tracking-wider">Traffic Flow</span>
         <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
          <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
          </svg>
         </div>
        </div>
        <div id="traffic-value" class="text-3xl font-bold metric-value">
         87%
        </div>
        <div class="text-xs text-gray-500 mt-1">
         Optimal Flow Rate
        </div>
        <div class="mt-3 h-1 bg-gray-800 rounded-full overflow-hidden">
         <div id="traffic-bar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 transition-all" style="width: 87%"></div>
        </div>
       </div><!-- Energy KPI -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4">
        <div class="flex items-center justify-between mb-3"><span class="text-xs text-gray-400 uppercase tracking-wider">Energy Grid</span>
         <div class="w-8 h-8 rounded-lg bg-yellow-500/20 flex items-center justify-center">
          <svg class="w-4 h-4 text-yellow-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
         </div>
        </div>
        <div id="energy-value" class="text-3xl font-bold metric-value">
         2.4 GW
        </div>
        <div class="text-xs text-gray-500 mt-1">
         Current Load
        </div>
        <div class="mt-3 flex gap-1">
         <div class="flex-1 h-6 bg-gray-800 rounded relative overflow-hidden">
          <div id="energy-bar" class="absolute inset-y-0 left-0 bg-gradient-to-r from-yellow-500 to-orange-400" style="width: 68%"></div><span class="absolute inset-0 flex items-center justify-center text-xs mono">68%</span>
         </div>
        </div>
       </div><!-- Emergency KPI -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4">
        <div class="flex items-center justify-between mb-3"><span class="text-xs text-gray-400 uppercase tracking-wider">Emergencies</span>
         <div id="emergency-icon" class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
          <svg class="w-4 h-4 text-green-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
         </div>
        </div>
        <div id="emergency-value" class="text-3xl font-bold metric-value">
         3
        </div>
        <div class="text-xs text-gray-500 mt-1">
         Active Incidents
        </div>
        <div class="mt-3 space-y-1" id="incident-list">
         <div class="flex items-center gap-2 text-xs"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> <span class="text-gray-400">Minor: 2</span>
         </div>
         <div class="flex items-center gap-2 text-xs"><span class="w-2 h-2 rounded-full bg-red-400"></span> <span class="text-gray-400">Critical: 1</span>
         </div>
        </div>
       </div><!-- Citizen Sentiment -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4 flex-1">
        <div class="flex items-center justify-between mb-3"><span class="text-xs text-gray-400 uppercase tracking-wider">Citizen Sentiment</span>
         <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
          <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
         </div>
        </div>
        <div class="flex items-end gap-1 h-20">
         <div class="flex-1 bg-green-500/30 rounded-t" style="height: 75%"></div>
         <div class="flex-1 bg-green-500/30 rounded-t" style="height: 82%"></div>
         <div class="flex-1 bg-yellow-500/30 rounded-t" style="height: 45%"></div>
         <div class="flex-1 bg-green-500/30 rounded-t" style="height: 90%"></div>
         <div class="flex-1 bg-green-500/30 rounded-t" style="height: 78%"></div>
         <div class="flex-1 bg-yellow-500/30 rounded-t" style="height: 55%"></div>
         <div class="flex-1 bg-green-500/30 rounded-t" style="height: 85%"></div>
        </div>
        <div class="mt-2 text-center"><span class="text-2xl font-bold metric-value">78%</span> <span class="text-xs text-gray-500 block">Positive</span>
        </div>
       </div>
      </div><!-- Center Column - City Map & Activity -->
      <div class="col-span-6 flex flex-col gap-4"><!-- City Visualization -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4 flex-1 relative overflow-hidden scan-effect">
        <div class="absolute top-4 left-4 z-10"><span class="text-xs text-gray-400 uppercase tracking-wider">City Digital Twin</span>
        </div>
        <div class="absolute top-4 right-4 z-10 flex gap-2"><button class="px-2 py-1 text-xs bg-[#00ff88]/20 text-[#00ff88] rounded border border-[#00ff88]/30 hover:bg-[#00ff88]/30 transition-all">LIVE</button> <button class="px-2 py-1 text-xs bg-gray-800 text-gray-400 rounded border border-gray-700 hover:border-gray-500 transition-all">24H</button>
        </div><!-- Simplified City Grid Visualization -->
        <div class="h-full flex items-center justify-center">
         <svg viewbox="0 0 400 300" class="w-full h-full max-h-[300px]"><!-- Grid Lines --> <defs>
           <pattern id="grid" width="20" height="20" patternunits="userSpaceOnUse">
            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#00ff8815" stroke-width="0.5" />
           </pattern>
           <lineargradient id="roadGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#1a1a1a" />
            <stop offset="50%" style="stop-color:#2a2a2a" />
            <stop offset="100%" style="stop-color:#1a1a1a" />
           </lineargradient>
          </defs> <rect width="400" height="300" fill="url(#grid)" /> <!-- Main Roads --> <rect x="0" y="140" width="400" height="20" fill="url(#roadGrad)" opacity="0.8" /> <rect x="190" y="0" width="20" height="300" fill="url(#roadGrad)" opacity="0.8" /> <!-- Districts --> <g id="districts"><!-- Downtown -->
           <rect x="220" y="20" width="80" height="60" rx="4" fill="#00ff8820" stroke="#00ff88" stroke-width="1" />
           <text x="260" y="55" fill="#00ff88" font-size="8" text-anchor="middle" class="mono">
            DOWNTOWN
           </text> <!-- Industrial -->
           <rect x="310" y="20" width="70" height="60" rx="4" fill="#f59e0b20" stroke="#f59e0b" stroke-width="1" />
           <text x="345" y="55" fill="#f59e0b" font-size="8" text-anchor="middle" class="mono">
            INDUSTRIAL
           </text> <!-- Residential -->
           <rect x="20" y="20" width="80" height="60" rx="4" fill="#3b82f620" stroke="#3b82f6" stroke-width="1" />
           <text x="60" y="55" fill="#3b82f6" font-size="8" text-anchor="middle" class="mono">
            RESIDENTIAL
           </text> <!-- Commercial -->
           <rect x="110" y="20" width="70" height="60" rx="4" fill="#8b5cf620" stroke="#8b5cf6" stroke-width="1" />
           <text x="145" y="55" fill="#8b5cf6" font-size="8" text-anchor="middle" class="mono">
            COMMERCIAL
           </text> <!-- Parks -->
           <rect x="20" y="170" width="80" height="50" rx="4" fill="#10b98120" stroke="#10b981" stroke-width="1" />
           <text x="60" y="200" fill="#10b981" font-size="8" text-anchor="middle" class="mono">
            PARKS
           </text> <!-- Hospital -->
           <rect x="310" y="170" width="70" height="50" rx="4" fill="#ef444420" stroke="#ef4444" stroke-width="1" />
           <text x="345" y="200" fill="#ef4444" font-size="8" text-anchor="middle" class="mono">
            HOSPITAL
           </text>
          </g> <!-- Traffic Nodes --> <g id="traffic-nodes">
           <circle cx="200" cy="150" r="8" fill="#00ff88" opacity="0.8">
            <animate attributename="r" values="8;12;8" dur="2s" repeatcount="indefinite" />
            <animate attributename="opacity" values="0.8;0.4;0.8" dur="2s" repeatcount="indefinite" />
           </circle>
           <circle cx="100" cy="150" r="5" fill="#3b82f6" opacity="0.6" />
           <circle cx="300" cy="150" r="5" fill="#f59e0b" opacity="0.6" />
           <circle cx="200" cy="80" r="5" fill="#00ff88" opacity="0.6" />
           <circle cx="200" cy="220" r="5" fill="#00ff88" opacity="0.6" />
          </g> <!-- Emergency Marker --> <g id="emergency-marker" transform="translate(330, 185)">
           <circle r="15" fill="#ef444440">
            <animate attributename="r" values="15;25;15" dur="1s" repeatcount="indefinite" />
            <animate attributename="opacity" values="0.4;0.1;0.4" dur="1s" repeatcount="indefinite" />
           </circle>
           <circle r="6" fill="#ef4444" />
           <text y="25" fill="#ef4444" font-size="7" text-anchor="middle" class="mono">
            INCIDENT
           </text>
          </g> <!-- Data Flow Lines --> <g opacity="0.3">
           <line x1="60" y1="80" x2="200" y2="150" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,4">
            <animate attributename="stroke-dashoffset" values="0;8" dur="1s" repeatcount="indefinite" />
           </line>
           <line x1="345" y1="80" x2="200" y2="150" stroke="#f59e0b" stroke-width="1" stroke-dasharray="4,4">
            <animate attributename="stroke-dashoffset" values="0;8" dur="1s" repeatcount="indefinite" />
           </line>
          </g>
         </svg>
        </div>
       </div><!-- Activity Feed -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4 h-48 overflow-hidden">
        <div class="flex items-center justify-between mb-3"><span class="text-xs text-gray-400 uppercase tracking-wider">Agent Activity Feed</span> <span class="text-xs mono text-[#00ff88]">LIVE</span>
        </div>
        <div id="activity-feed" class="space-y-2 h-32 overflow-y-auto pr-2"><!-- Activity items will be populated dynamically -->
        </div>
       </div>
      </div><!-- Right Column - Agent Status & Decisions -->
      <div class="col-span-3 flex flex-col gap-4"><!-- Coordinator Status -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4">
        <div class="flex items-center gap-3 mb-4">
         <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex items-center justify-center">
          <svg class="w-5 h-5 text-[#0a0a0a]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
          </svg>
         </div>
         <div>
          <h3 class="font-semibold">Coordinator AI</h3>
          <p class="text-xs text-gray-500">Global State Manager</p>
         </div>
        </div>
        <div class="space-y-2">
         <div class="flex justify-between text-xs"><span class="text-gray-400">Processing Load</span> <span class="mono text-[#00ff88]">42%</span>
         </div>
         <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
          <div class="h-full w-[42%] bg-gradient-to-r from-[#00ff88] to-[#00d4ff]"></div>
         </div>
         <div class="flex justify-between text-xs mt-2"><span class="text-gray-400">Decisions/min</span> <span class="mono text-[#00ff88]">127</span>
         </div>
        </div>
       </div><!-- Recent Decisions -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4 flex-1 overflow-hidden">
        <div class="flex items-center justify-between mb-3"><span class="text-xs text-gray-400 uppercase tracking-wider">Recent Decisions</span> <button class="text-xs text-[#00ff88] hover:underline">View All</button>
        </div>
        <div id="decisions-list" class="space-y-3 h-full overflow-y-auto pb-4"><!-- Decisions will be populated dynamically -->
        </div>
       </div><!-- Quick Actions -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-4"><span class="text-xs text-gray-400 uppercase tracking-wider block mb-3">Quick Actions</span>
        <div class="grid grid-cols-2 gap-2"><button id="btn-simulate-emergency" class="p-2 text-xs bg-red-500/20 text-red-400 rounded-lg border border-red-500/30 hover:bg-red-500/30 transition-all"> ðŸš¨ Simulate Emergency </button> <button id="btn-optimize-traffic" class="p-2 text-xs bg-blue-500/20 text-blue-400 rounded-lg border border-blue-500/30 hover:bg-blue-500/30 transition-all"> ðŸš¦ Optimize Traffic </button> <button id="btn-balance-energy" class="p-2 text-xs bg-yellow-500/20 text-yellow-400 rounded-lg border border-yellow-500/30 hover:bg-yellow-500/30 transition-all"> âš¡ Balance Grid </button> <button id="btn-daily-report" class="p-2 text-xs bg-purple-500/20 text-purple-400 rounded-lg border border-purple-500/30 hover:bg-purple-500/30 transition-all"> ðŸ“Š Daily Report </button>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Agents Tab -->
    <div id="tab-agents" class="tab-content h-full p-6 hidden">
     <div class="grid grid-cols-3 gap-6 h-full"><!-- Traffic Agent -->
      <div class="agent-card rounded-xl bg-[#111]/80 p-6 flex flex-col">
       <div class="flex items-center gap-4 mb-4">
        <div class="w-14 h-14 rounded-xl bg-blue-500/20 flex items-center justify-center">
         <svg class="w-7 h-7 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
         </svg>
        </div>
        <div>
         <h3 class="text-lg font-bold">Traffic Agent</h3>
         <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> <span class="text-xs text-gray-400">Active</span>
         </div>
        </div>
       </div>
       <div class="space-y-3 flex-1">
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Current Analysis
         </div>
         <div class="text-sm">
          Monitoring 847 intersections
         </div>
        </div>
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Congestion Points
         </div>
         <div class="text-2xl font-bold text-blue-400">
          12
         </div>
        </div>
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Recent Actions
         </div>
         <ul class="text-xs space-y-1 text-gray-300">
          <li>â€¢ Adjusted timing: Main St &amp; 5th Ave</li>
          <li>â€¢ Reroute suggested: Highway 101</li>
          <li>â€¢ Incident detected: Downtown</li>
         </ul>
        </div>
       </div>
       <div class="mt-4 pt-4 border-t border-gray-800">
        <div class="flex justify-between text-xs mb-2"><span class="text-gray-400">Processing</span> <span class="mono text-blue-400">2.3k events/s</span>
        </div>
        <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
         <div class="h-full w-[78%] bg-blue-500"></div>
        </div>
       </div>
      </div><!-- Energy Agent -->
      <div class="agent-card rounded-xl bg-[#111]/80 p-6 flex flex-col">
       <div class="flex items-center gap-4 mb-4">
        <div class="w-14 h-14 rounded-xl bg-yellow-500/20 flex items-center justify-center">
         <svg class="w-7 h-7 text-yellow-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
         </svg>
        </div>
        <div>
         <h3 class="text-lg font-bold">Energy Agent</h3>
         <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> <span class="text-xs text-gray-400">Active</span>
         </div>
        </div>
       </div>
       <div class="space-y-3 flex-1">
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Grid Status
         </div>
         <div class="text-sm">
          All substations nominal
         </div>
        </div>
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Peak Forecast
         </div>
         <div class="text-2xl font-bold text-yellow-400">
          3.1 GW
         </div>
         <div class="text-xs text-gray-500">
          Expected at 18:00
         </div>
        </div>
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Anomalies
         </div>
         <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> <span class="text-xs">1 spike detected in Industrial zone</span>
         </div>
        </div>
       </div>
       <div class="mt-4 pt-4 border-t border-gray-800">
        <div class="flex justify-between text-xs mb-2"><span class="text-gray-400">Load Balance</span> <span class="mono text-yellow-400">Optimal</span>
        </div>
        <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
         <div class="h-full w-[68%] bg-yellow-500"></div>
        </div>
       </div>
      </div><!-- Emergency Agent -->
      <div class="agent-card rounded-xl bg-[#111]/80 p-6 flex flex-col">
       <div class="flex items-center gap-4 mb-4">
        <div class="w-14 h-14 rounded-xl bg-red-500/20 flex items-center justify-center">
         <svg class="w-7 h-7 text-red-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
         </svg>
        </div>
        <div>
         <h3 class="text-lg font-bold">Emergency Agent</h3>
         <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span> <span class="text-xs text-yellow-400">Alert</span>
         </div>
        </div>
       </div>
       <div class="space-y-3 flex-1">
        <div class="p-3 bg-red-500/10 rounded-lg border border-red-500/30">
         <div class="text-xs text-red-400 mb-1">
          Active Incident
         </div>
         <div class="text-sm">
          Traffic accident - Hospital District
         </div>
         <div class="text-xs text-gray-500 mt-1">
          Response ETA: 4 min
         </div>
        </div>
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Units Available
         </div>
         <div class="grid grid-cols-3 gap-2 mt-2">
          <div class="text-center">
           <div class="text-lg font-bold text-red-400">
            12
           </div>
           <div class="text-xs text-gray-500">
            Fire
           </div>
          </div>
          <div class="text-center">
           <div class="text-lg font-bold text-blue-400">
            24
           </div>
           <div class="text-xs text-gray-500">
            Police
           </div>
          </div>
          <div class="text-center">
           <div class="text-lg font-bold text-green-400">
            8
           </div>
           <div class="text-xs text-gray-500">
            EMS
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="mt-4 pt-4 border-t border-gray-800">
        <div class="flex justify-between text-xs mb-2"><span class="text-gray-400">Response Time</span> <span class="mono text-red-400">4.2 min avg</span>
        </div>
        <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
         <div class="h-full w-[85%] bg-red-500"></div>
        </div>
       </div>
      </div><!-- Citizen Agent -->
      <div class="agent-card rounded-xl bg-[#111]/80 p-6 flex flex-col">
       <div class="flex items-center gap-4 mb-4">
        <div class="w-14 h-14 rounded-xl bg-purple-500/20 flex items-center justify-center">
         <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" />
         </svg>
        </div>
        <div>
         <h3 class="text-lg font-bold">Citizen Agent</h3>
         <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> <span class="text-xs text-gray-400">Active</span>
         </div>
        </div>
       </div>
       <div class="space-y-3 flex-1">
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-1">
          Complaints Today
         </div>
         <div class="text-2xl font-bold text-purple-400">
          147
         </div>
        </div>
        <div class="p-3 bg-[#0a0a0a] rounded-lg">
         <div class="text-xs text-gray-400 mb-2">
          Top Categories
         </div>
         <div class="space-y-2">
          <div class="flex items-center gap-2">
           <div class="flex-1 h-2 bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full w-[45%] bg-purple-500"></div>
           </div><span class="text-xs text-gray-400 w-16">Traffic</span>
          </div>
          <div class="flex items-center gap-2">
           <div class="flex-1 h-2 bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full w-[30%] bg-purple-500"></div>
           </div><span class="text-xs text-gray-400 w-16">Utilities</span>
          </div>
          <div class="flex items-center gap-2">
           <div class="flex-1 h-2 bg-gray-800 rounded-full overflow-hidden">
            <div class="h-full w-[25%] bg-purple-500"></div>
           </div><span class="text-xs text-gray-400 w-16">Safety</span>
          </div>
         </div>
        </div>
       </div>
       <div class="mt-4 pt-4 border-t border-gray-800">
        <div class="flex justify-between text-xs mb-2"><span class="text-gray-400">NLP Processing</span> <span class="mono text-purple-400">Real-time</span>
        </div>
        <div class="h-1 bg-gray-800 rounded-full overflow-hidden">
         <div class="h-full w-[92%] bg-purple-500"></div>
        </div>
       </div>
      </div><!-- Coordinator Agent (Larger) -->
      <div class="agent-card rounded-xl bg-[#111]/80 p-6 col-span-2 flex flex-col">
       <div class="flex items-center gap-4 mb-4">
        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex items-center justify-center">
         <svg class="w-7 h-7 text-[#0a0a0a]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
         </svg>
        </div>
        <div>
         <h3 class="text-lg font-bold">Coordinator Agent</h3>
         <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-[#00ff88] animate-pulse"></span> <span class="text-xs text-[#00ff88]">Orchestrating</span>
         </div>
        </div>
       </div>
       <div class="grid grid-cols-2 gap-4 flex-1">
        <div class="space-y-3">
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="text-xs text-gray-400 mb-1">
           Global City State
          </div>
          <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-[#00ff88]"></span> <span class="text-sm font-medium">OPERATIONAL</span>
          </div>
         </div>
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="text-xs text-gray-400 mb-1">
           Agent Connections
          </div>
          <div class="flex gap-2 mt-2"><span class="px-2 py-1 text-xs rounded bg-blue-500/20 text-blue-400">Traffic âœ“</span> <span class="px-2 py-1 text-xs rounded bg-yellow-500/20 text-yellow-400">Energy âœ“</span> <span class="px-2 py-1 text-xs rounded bg-red-500/20 text-red-400">Emergency âœ“</span> <span class="px-2 py-1 text-xs rounded bg-purple-500/20 text-purple-400">Citizen âœ“</span>
          </div>
         </div>
        </div>
        <div class="space-y-3">
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="text-xs text-gray-400 mb-1">
           Conflict Resolution
          </div>
          <div class="text-xs text-gray-300">
           <p class="mb-1">â€¢ Traffic vs Emergency: Priority to EMS routes</p>
           <p class="mb-1">â€¢ Energy load vs Events: Dynamic allocation</p>
           <p>â€¢ Resource conflicts: AI-optimized scheduling</p>
          </div>
         </div>
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="text-xs text-gray-400 mb-1">
           Compressed Context Size
          </div>
          <div class="flex items-center gap-3">
           <div class="text-2xl font-bold metric-value">
            2.4 KB
           </div>
           <div class="text-xs text-gray-500">
            <div>
             vs 847 KB raw
            </div>
            <div class="text-[#00ff88]">
             99.7% reduction
            </div>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- ScaleDown/Compression Tab -->
    <div id="tab-compression" class="tab-content h-full p-6 hidden">
     <div class="grid grid-cols-2 gap-6 h-full"><!-- Compression Metrics -->
      <div class="space-y-6">
       <div class="agent-card rounded-xl bg-[#111]/80 p-6">
        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
         <svg class="w-5 h-5 text-[#00ff88]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
         </svg> ScaleDown Compression Metrics</h3>
        <div class="grid grid-cols-2 gap-4 mb-6">
         <div class="p-4 bg-[#0a0a0a] rounded-lg text-center">
          <div class="text-3xl font-bold metric-value" id="compression-ratio">
           67%
          </div>
          <div class="text-xs text-gray-400 mt-1">
           Data Reduction
          </div>
         </div>
         <div class="p-4 bg-[#0a0a0a] rounded-lg text-center">
          <div class="text-3xl font-bold metric-value" id="latency-improvement">
           3.2x
          </div>
          <div class="text-xs text-gray-400 mt-1">
           Faster Response
          </div>
         </div>
        </div>
        <div class="space-y-4">
         <div>
          <div class="flex justify-between text-sm mb-2"><span class="text-gray-400">Traffic Sensor Logs</span> <span class="mono text-[#00ff88]">-78%</span>
          </div>
          <div class="h-3 bg-gray-800 rounded-full overflow-hidden relative">
           <div class="absolute inset-0 flex">
            <div class="bg-red-500/50 w-full"></div>
           </div>
           <div class="compression-bar h-full relative z-10" style="width: 22%"></div>
          </div>
          <div class="flex justify-between text-xs mt-1 text-gray-500"><span>Before: 245 KB</span> <span>After: 54 KB</span>
          </div>
         </div>
         <div>
          <div class="flex justify-between text-sm mb-2"><span class="text-gray-400">Energy Time Series</span> <span class="mono text-[#00ff88]">-85%</span>
          </div>
          <div class="h-3 bg-gray-800 rounded-full overflow-hidden relative">
           <div class="absolute inset-0 flex">
            <div class="bg-yellow-500/50 w-full"></div>
           </div>
           <div class="compression-bar h-full relative z-10" style="width: 15%"></div>
          </div>
          <div class="flex justify-between text-xs mt-1 text-gray-500"><span>Before: 180 KB</span> <span>After: 27 KB</span>
          </div>
         </div>
         <div>
          <div class="flex justify-between text-sm mb-2"><span class="text-gray-400">Citizen Complaints</span> <span class="mono text-[#00ff88]">-62%</span>
          </div>
          <div class="h-3 bg-gray-800 rounded-full overflow-hidden relative">
           <div class="absolute inset-0 flex">
            <div class="bg-purple-500/50 w-full"></div>
           </div>
           <div class="compression-bar h-full relative z-10" style="width: 38%"></div>
          </div>
          <div class="flex justify-between text-xs mt-1 text-gray-500"><span>Before: 92 KB</span> <span>After: 35 KB</span>
          </div>
         </div>
         <div>
          <div class="flex justify-between text-sm mb-2"><span class="text-gray-400">Agent Communication</span> <span class="mono text-[#00ff88]">-91%</span>
          </div>
          <div class="h-3 bg-gray-800 rounded-full overflow-hidden relative">
           <div class="absolute inset-0 flex">
            <div class="bg-cyan-500/50 w-full"></div>
           </div>
           <div class="compression-bar h-full relative z-10" style="width: 9%"></div>
          </div>
          <div class="flex justify-between text-xs mt-1 text-gray-500"><span>Before: 330 KB</span> <span>After: 30 KB</span>
          </div>
         </div>
        </div>
       </div><!-- Token Usage -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-6">
        <h3 class="text-lg font-bold mb-4">Token/Data Volume Savings</h3>
        <div class="flex items-center gap-6">
         <div class="flex-1">
          <div class="text-xs text-gray-400 mb-2">
           Before Compression
          </div>
          <div class="flex items-end gap-1 h-24">
           <div class="flex-1 bg-red-500/30 rounded-t" style="height: 100%"></div>
           <div class="flex-1 bg-red-500/30 rounded-t" style="height: 85%"></div>
           <div class="flex-1 bg-red-500/30 rounded-t" style="height: 92%"></div>
           <div class="flex-1 bg-red-500/30 rounded-t" style="height: 78%"></div>
           <div class="flex-1 bg-red-500/30 rounded-t" style="height: 95%"></div>
          </div>
          <div class="text-center mt-2"><span class="text-xl font-bold text-red-400">847 KB</span>
          </div>
         </div>
         <div class="text-4xl text-gray-600">
          â†’
         </div>
         <div class="flex-1">
          <div class="text-xs text-gray-400 mb-2">
           After Compression
          </div>
          <div class="flex items-end gap-1 h-24">
           <div class="flex-1 bg-[#00ff88]/30 rounded-t" style="height: 22%"></div>
           <div class="flex-1 bg-[#00ff88]/30 rounded-t" style="height: 15%"></div>
           <div class="flex-1 bg-[#00ff88]/30 rounded-t" style="height: 38%"></div>
           <div class="flex-1 bg-[#00ff88]/30 rounded-t" style="height: 9%"></div>
           <div class="flex-1 bg-[#00ff88]/30 rounded-t" style="height: 12%"></div>
          </div>
          <div class="text-center mt-2"><span class="text-xl font-bold text-[#00ff88]">146 KB</span>
          </div>
         </div>
        </div>
       </div>
      </div><!-- Compression Details -->
      <div class="space-y-6"><!-- Short-term vs Long-term State -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-6">
        <h3 class="text-lg font-bold mb-4">State Management Strategy</h3>
        <div class="grid grid-cols-2 gap-4">
         <div class="p-4 bg-[#0a0a0a] rounded-lg border border-blue-500/30">
          <div class="flex items-center gap-2 mb-3">
           <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
           </svg><span class="text-sm font-medium text-blue-400">Short-term (24-48h)</span>
          </div>
          <ul class="text-xs space-y-1 text-gray-300">
           <li>â€¢ Full sensor granularity</li>
           <li>â€¢ Minute-by-minute logs</li>
           <li>â€¢ Raw complaint text</li>
           <li>â€¢ Detailed decisions</li>
          </ul>
          <div class="mt-3 pt-3 border-t border-gray-800">
           <div class="text-xs text-gray-400">
            Storage: <span class="text-blue-400">~50 MB</span>
           </div>
          </div>
         </div>
         <div class="p-4 bg-[#0a0a0a] rounded-lg border border-[#00ff88]/30">
          <div class="flex items-center gap-2 mb-3">
           <svg class="w-4 h-4 text-[#00ff88]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
           </svg><span class="text-sm font-medium text-[#00ff88]">Long-term (weeks/months)</span>
          </div>
          <ul class="text-xs space-y-1 text-gray-300">
           <li>â€¢ Hourly aggregates</li>
           <li>â€¢ Trend summaries</li>
           <li>â€¢ Category statistics</li>
           <li>â€¢ Pattern recognition</li>
          </ul>
          <div class="mt-3 pt-3 border-t border-gray-800">
           <div class="text-xs text-gray-400">
            Storage: <span class="text-[#00ff88]">~2 MB/month</span>
           </div>
          </div>
         </div>
        </div>
       </div><!-- Compression Techniques -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-6">
        <h3 class="text-lg font-bold mb-4">Compression Techniques Used</h3>
        <div class="space-y-3">
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="flex items-center justify-between mb-2"><span class="text-sm font-medium">Time-Series Downsampling</span> <span class="text-xs px-2 py-1 rounded bg-[#00ff88]/20 text-[#00ff88]">Active</span>
          </div>
          <p class="text-xs text-gray-400">Reduces sensor readings from 1/second to 1/minute averages for historical data</p>
         </div>
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="flex items-center justify-between mb-2"><span class="text-sm font-medium">NLP Summarization</span> <span class="text-xs px-2 py-1 rounded bg-[#00ff88]/20 text-[#00ff88]">Active</span>
          </div>
          <p class="text-xs text-gray-400">Extracts key entities and sentiment from citizen complaints</p>
         </div>
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="flex items-center justify-between mb-2"><span class="text-sm font-medium">Delta Encoding</span> <span class="text-xs px-2 py-1 rounded bg-[#00ff88]/20 text-[#00ff88]">Active</span>
          </div>
          <p class="text-xs text-gray-400">Stores only changes between agent state updates</p>
         </div>
         <div class="p-3 bg-[#0a0a0a] rounded-lg">
          <div class="flex items-center justify-between mb-2"><span class="text-sm font-medium">Semantic Hashing</span> <span class="text-xs px-2 py-1 rounded bg-[#00ff88]/20 text-[#00ff88]">Active</span>
          </div>
          <p class="text-xs text-gray-400">Compresses similar events into representative patterns</p>
         </div>
        </div>
       </div><!-- Live Compression Stats -->
       <div class="agent-card rounded-xl bg-[#111]/80 p-6">
        <h3 class="text-lg font-bold mb-4">Real-time Compression Stats</h3>
        <div class="mono text-xs bg-[#0a0a0a] p-4 rounded-lg overflow-auto max-h-40">
         <div class="text-gray-500">
          [ScaleDown Engine v2.1]
         </div>
         <div class="text-[#00ff88]">
          âœ“ Traffic batch compressed: 245KB â†’ 54KB (78%)
         </div>
         <div class="text-[#00ff88]">
          âœ“ Energy series compressed: 180KB â†’ 27KB (85%)
         </div>
         <div class="text-[#00ff88]">
          âœ“ Complaints summarized: 92KB â†’ 35KB (62%)
         </div>
         <div class="text-[#00ff88]">
          âœ“ Agent sync delta: 330KB â†’ 30KB (91%)
         </div>
         <div class="text-yellow-400">
          âš¡ Latency reduced: 340ms â†’ 105ms
         </div>
         <div class="text-gray-500">
          ---
         </div>
         <div class="text-cyan-400">
          Total context: 847KB â†’ 146KB (82.8% reduction)
         </div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Chat Tab -->
    <div id="tab-chat" class="tab-content h-full p-6 hidden">
     <div class="grid grid-cols-3 gap-6 h-full"><!-- Chat Interface -->
      <div class="col-span-2 agent-card rounded-xl bg-[#111]/80 flex flex-col">
       <div class="p-4 border-b border-gray-800">
        <div class="flex items-center justify-between">
         <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex items-center justify-center">
           <svg class="w-5 h-5 text-[#0a0a0a]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
           </svg>
          </div>
          <div>
           <h3 class="font-semibold">City Control Assistant</h3>
           <p class="text-xs text-gray-400">Ask about city status, decisions, or run commands</p>
          </div>
         </div><button id="clear-chat" class="text-xs text-gray-400 hover:text-white transition-colors">Clear</button>
        </div>
       </div>
       <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4"><!-- Welcome Message -->
        <div class="chat-message flex gap-3">
         <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex-shrink-0 flex items-center justify-center">
          <svg class="w-4 h-4 text-[#0a0a0a]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
         </div>
         <div class="flex-1">
          <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-800">
           <p class="text-sm">Welcome to the Smart City Control Center! I can help you:</p>
           <ul class="text-xs text-gray-400 mt-2 space-y-1">
            <li>â€¢ Query city status ("What's the traffic like?")</li>
            <li>â€¢ Understand decisions ("Why was route 101 rerouted?")</li>
            <li>â€¢ Run commands ("Optimize downtown traffic")</li>
            <li>â€¢ Get reports ("Give me the daily summary")</li>
           </ul>
          </div>
         </div>
        </div>
       </div>
       <div class="p-4 border-t border-gray-800">
        <form id="chat-form" class="flex gap-3"><input type="text" id="chat-input" placeholder="Ask about city status or send a command..." class="flex-1 bg-[#0a0a0a] border border-gray-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-[#00ff88] transition-colors"> <button type="submit" class="px-6 py-3 bg-gradient-to-r from-[#00ff88] to-[#00d4ff] text-[#0a0a0a] font-medium rounded-lg hover:opacity-90 transition-opacity"> Send </button>
        </form><!-- Quick Commands -->
        <div class="flex gap-2 mt-3 flex-wrap"><button class="quick-cmd px-3 py-1.5 text-xs bg-[#0a0a0a] border border-gray-700 rounded-full hover:border-[#00ff88] hover:text-[#00ff88] transition-all"> City status </button> <button class="quick-cmd px-3 py-1.5 text-xs bg-[#0a0a0a] border border-gray-700 rounded-full hover:border-[#00ff88] hover:text-[#00ff88] transition-all"> Traffic report </button> <button class="quick-cmd px-3 py-1.5 text-xs bg-[#0a0a0a] border border-gray-700 rounded-full hover:border-[#00ff88] hover:text-[#00ff88] transition-all"> Energy forecast </button> <button class="quick-cmd px-3 py-1.5 text-xs bg-[#0a0a0a] border border-gray-700 rounded-full hover:border-[#00ff88] hover:text-[#00ff88] transition-all"> Active emergencies </button> <button class="quick-cmd px-3 py-1.5 text-xs bg-[#0a0a0a] border border-gray-700 rounded-full hover:border-[#00ff88] hover:text-[#00ff88] transition-all"> Daily summary </button>
        </div>
       </div>
      </div><!-- Voice Interface -->
      <div class="agent-card rounded-xl bg-[#111]/80 flex flex-col">
       <div class="p-4 border-b border-gray-800">
        <h3 class="font-semibold flex items-center gap-2">
         <svg class="w-5 h-5 text-[#00ff88]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
         </svg> Voice Interface</h3>
       </div>
       <div class="flex-1 flex flex-col items-center justify-center p-6"><button id="voice-button" class="w-24 h-24 rounded-full bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex items-center justify-center hover:scale-105 transition-transform shadow-lg shadow-[#00ff88]/20">
         <svg class="w-10 h-10 text-[#0a0a0a]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
         </svg></button>
        <p id="voice-status" class="mt-4 text-sm text-gray-400">Click to speak</p>
        <p id="voice-transcript" class="mt-2 text-xs text-[#00ff88] h-8 text-center"></p>
       </div>
       <div class="p-4 border-t border-gray-800">
        <p class="text-xs text-gray-400 mb-3">Voice Commands:</p>
        <div class="space-y-2">
         <div class="flex items-center gap-2 text-xs"><span class="text-[#00ff88]">â†’</span> <span>"What's the city status?"</span>
         </div>
         <div class="flex items-center gap-2 text-xs"><span class="text-[#00ff88]">â†’</span> <span>"Simulate an emergency"</span>
         </div>
         <div class="flex items-center gap-2 text-xs"><span class="text-[#00ff88]">â†’</span> <span>"Give me the daily summary"</span>
         </div>
         <div class="flex items-center gap-2 text-xs"><span class="text-[#00ff88]">â†’</span> <span>"Optimize traffic now"</span>
         </div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </main><!-- Toast Container -->
   <div id="toast-container" class="fixed bottom-4 right-4 space-y-2 z-50"></div><!-- Voice Modal -->
   <div id="voice-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-[#111] rounded-2xl p-8 max-w-md w-full mx-4 border border-[#00ff88]/30">
     <div class="text-center">
      <div class="w-32 h-32 mx-auto rounded-full bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex items-center justify-center animate-pulse">
       <svg class="w-16 h-16 text-[#0a0a0a]" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
       </svg>
      </div>
      <p id="modal-voice-status" class="mt-6 text-lg">Listening...</p>
      <p id="modal-voice-transcript" class="mt-2 text-sm text-[#00ff88] min-h-[20px]"></p><button id="close-voice-modal" class="mt-6 px-6 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors"> Cancel </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ==================== API INTEGRATION ====================
    async function callAgentAPI(agentType, context, prompt) {
      try {
        const response = await fetch('/agent/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ agentType, context, prompt })
        });
        const data = await response.json();
        return data.analysis || 'Analysis complete';
      } catch (err) {
        console.error('Agent API error:', err);
        return 'Analysis failed';
      }
    }
    
    async function callChatAPI(message, cityState) {
      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message, cityState })
        });
        
        const data = await response.json();
        
        // If API returns error, use fallback
        if (!response.ok || data.error) {
          console.log('API failed, using fallback response');
          return getFallbackResponse(message);
        }
        
        return data.response || getFallbackResponse(message);
      } catch (err) {
        console.error('Chat API error:', err);
        return getFallbackResponse(message);
      }
    }
    
    // Format JSON data into user-friendly text
    function formatCityStatus(data) {
      if (typeof data === 'string') {
        try {
          data = JSON.parse(data);
        } catch (e) {
          return data; // Return as-is if not JSON
        }
      }
      
      if (data.timestamp && data.traffic) {
        return `ðŸ™ï¸ **Smart City Status Report**
ðŸ“… ${new Date(data.timestamp).toLocaleString()}

ðŸš¦ **Traffic System**
   â€¢ Flow Rate: ${data.traffic.flow}% (${data.traffic.flow > 80 ? 'Excellent' : data.traffic.flow > 60 ? 'Good' : 'Needs Attention'})
   â€¢ Congestion Points: ${data.traffic.congestion}
   â€¢ Weekly Trend: ${data.traffic.trend}%

âš¡ **Energy Grid**
   â€¢ Current Load: ${data.energy.load} GW
   â€¢ Peak Capacity: ${data.energy.peak} GW
   â€¢ Utilization: ${Math.round((data.energy.load / data.energy.peak) * 100)}%
   â€¢ Anomalies: ${data.energy.anomalies}

ðŸš¨ **Emergency Services**
   â€¢ Active Incidents: ${data.emergency.active}
   â€¢ Avg Response Time: ${data.emergency.response} minutes
   â€¢ Status: ${data.emergency.response < 5 ? 'âœ… Optimal' : 'âš ï¸ Elevated'}

ðŸ‘¥ **Citizen Sentiment**
   â€¢ Overall Satisfaction: ${data.citizen.sentiment}%
   â€¢ Today's Complaints: ${data.citizen.complaints}
   â€¢ Mood: ${data.citizen.sentiment > 75 ? 'ðŸ˜Š Positive' : data.citizen.sentiment > 50 ? 'ðŸ˜ Neutral' : 'ðŸ˜Ÿ Negative'}

ðŸ“Š **System Status: ${data.traffic.flow > 70 && data.energy.anomalies === 0 && data.emergency.response < 6 ? 'ðŸŸ¢ OPERATIONAL' : 'ðŸŸ¡ MONITORING'}**`;
      }
      
      return typeof data === 'object' ? JSON.stringify(data, null, 2) : String(data);
    }

    function getFallbackResponse(message) {
      const msg = message.toLowerCase();
      const ctx = cityStateManager.getCompressedContext();
      
      if (msg.includes('status') || msg.includes('city')) {
        return formatCityStatus(ctx);
      }
      if (msg.includes('traffic')) {
        return `Traffic Report\n\nFlow rate: ${ctx.traffic.flow}%\nCongestion points: ${ctx.traffic.congestion}\nAll major intersections operational.`;
      }
      if (msg.includes('energy')) {
        return `Energy Status\n\nCurrent load: ${ctx.energy.load} GW\nPeak forecast: ${ctx.energy.peak} GW\nGrid operating normally.`;
      }
      if (msg.includes('emergency') || msg.includes('emergencies')) {
        return `Emergency Status\n\nActive incidents: ${ctx.emergency.active}\nAverage response time: ${ctx.emergency.response} min\nAll units ready.`;
      }
      if (msg.includes('summary') || msg.includes('report')) {
        return `Daily Summary\n\nðŸ“Š Overall Status: OPERATIONAL\n\nðŸš¦ Traffic: Good (${ctx.traffic.flow}% flow)\nâš¡ Energy: Normal (${ctx.energy.load} GW)\nðŸš¨ Response: Optimal (${ctx.emergency.response} min avg)\nðŸ‘¥ Sentiment: Positive (${ctx.citizen.sentiment}%)`;
      }
      if (msg.includes('hi') || msg.includes('hello') || msg.includes('hey')) {
        return `Hello! I'm your Smart City Assistant. I can help you with:\n\nâ€¢ City status reports\nâ€¢ Traffic information\nâ€¢ Energy grid status\nâ€¢ Emergency updates\nâ€¢ Daily summaries\n\nWhat would you like to know?`;
      }
      // Check if message looks like JSON data
      if (message.trim().startsWith('{') && message.trim().endsWith('}')) {
        return formatCityStatus(message);
      }
      
      return `I can help you with: city status, traffic report, energy forecast, active emergencies, or daily summary. What would you like to know?`;
    }
    
    // ==================== CONFIGURATION ====================
    const defaultConfig = {
      city_name: 'METROPOLIS DIGITAL TWIN',
      dashboard_title: 'Smart City Control Center',
      background_color: '#0a0a0a',
      surface_color: '#111111',
      text_color: '#f3f4f6',
      primary_action_color: '#00ff88',
      secondary_action_color: '#00d4ff'
    };
    
    let config = { ...defaultConfig };
    let cityState = {};
    let agentDecisions = [];
    let activityLog = [];
    
    // ==================== CITY STATE (Compressed) ====================
    class CityStateManager {
      constructor() {
        this.shortTermState = {
          traffic: { congestionPoints: [], flowRate: 87, incidents: [] },
          energy: { currentLoad: 2.4, peakForecast: 3.1, anomalies: [] },
          emergency: { activeIncidents: 3, units: { fire: 12, police: 24, ems: 8 } },
          citizen: { complaintsToday: 147, sentiment: 78, topCategories: ['Traffic', 'Utilities', 'Safety'] }
        };
        
        this.longTermTrends = {
          traffic: { weeklyAvgFlow: 82, monthlyIncidents: 47 },
          energy: { weeklyPeakAvg: 2.9, monthlyConsumption: 1847 },
          emergency: { avgResponseTime: 4.2, monthlyIncidents: 234 },
          citizen: { weeklyComplaints: 892, monthlyTrend: '+5%' }
        };
        
        this.compressionMetrics = {
          rawSize: 847,
          compressedSize: 146,
          reductionPercent: 82.8,
          latencyBefore: 340,
          latencyAfter: 105
        };
      }
      
      getCompressedContext() {
        return {
          timestamp: new Date().toISOString(),
          traffic: {
            flow: this.shortTermState.traffic.flowRate,
            congestion: this.shortTermState.traffic.congestionPoints.length,
            trend: this.longTermTrends.traffic.weeklyAvgFlow
          },
          energy: {
            load: this.shortTermState.energy.currentLoad,
            peak: this.shortTermState.energy.peakForecast,
            anomalies: this.shortTermState.energy.anomalies.length
          },
          emergency: {
            active: this.shortTermState.emergency.activeIncidents,
            response: this.longTermTrends.emergency.avgResponseTime
          },
          citizen: {
            sentiment: this.shortTermState.citizen.sentiment,
            complaints: this.shortTermState.citizen.complaintsToday
          }
        };
      }
      
      updateFromAgent(agentType, data) {
        if (this.shortTermState[agentType]) {
          Object.assign(this.shortTermState[agentType], data);
        }
      }
    }
    
    const cityStateManager = new CityStateManager();
    
    // ==================== AI AGENTS ====================
    class Agent {
      constructor(name, type) {
        this.name = name;
        this.type = type;
        this.status = 'active';
        this.lastAction = null;
      }
      
      analyze(context) {
        // Override in subclasses
      }
      
      decide(analysis) {
        // Override in subclasses
      }
      
      act(decision) {
        this.lastAction = { decision, timestamp: new Date().toISOString() };
        return this.lastAction;
      }
    }
    
    class TrafficAgent extends Agent {
      constructor() {
        super('Traffic Agent', 'traffic');
      }
      
      analyze(context) {
        const congestion = context.traffic?.congestion || 0;
        const flow = context.traffic?.flow || 87;
        
        // Call API for real analysis
        callAgentAPI('Traffic', context, 'Analyze traffic conditions and suggest optimizations').then(apiResult => {
          addActivityItem('Traffic Agent', `API Analysis: ${apiResult.substring(0, 100)}...`, 'normal');
        });
        
        return {
          congestionLevel: congestion > 10 ? 'high' : congestion > 5 ? 'medium' : 'low',
          flowOptimization: flow < 70 ? 'needed' : 'optimal',
          incidents: cityStateManager.shortTermState.traffic.incidents
        };
      }
      
      decide(analysis) {
        const decisions = [];
        if (analysis.congestionLevel === 'high') {
          decisions.push({ action: 'reroute', reason: 'High congestion detected', priority: 'high' });
        }
        if (analysis.flowOptimization === 'needed') {
          decisions.push({ action: 'adjust_signals', reason: 'Flow below optimal', priority: 'medium' });
        }
        return decisions;
      }
    }
    
    class EnergyAgent extends Agent {
      constructor() {
        super('Energy Agent', 'energy');
      }
      
      analyze(context) {
        const load = context.energy?.load || 2.4;
        const peak = context.energy?.peak || 3.1;
        
        // Call API for real analysis
        callAgentAPI('Energy', context, 'Analyze energy grid status and predict load patterns').then(apiResult => {
          addActivityItem('Energy Agent', `API Analysis: ${apiResult.substring(0, 100)}...`, 'normal');
        });
        
        return {
          loadStatus: load / 3.5 > 0.8 ? 'critical' : load / 3.5 > 0.6 ? 'elevated' : 'normal',
          peakRisk: peak > 3.0 ? 'high' : 'normal',
          anomalies: context.energy?.anomalies || 0
        };
      }
      
      decide(analysis) {
        const decisions = [];
        if (analysis.loadStatus === 'critical') {
          decisions.push({ action: 'load_shed', reason: 'Critical load level', priority: 'critical' });
        }
        if (analysis.peakRisk === 'high') {
          decisions.push({ action: 'preemptive_balance', reason: 'High peak forecast', priority: 'high' });
        }
        return decisions;
      }
    }
    
    class EmergencyAgent extends Agent {
      constructor() {
        super('Emergency Agent', 'emergency');
      }
      
      analyze(context) {
        const active = context.emergency?.active || 3;
        const responseTime = context.emergency?.response || 4.2;
        
        // Call API for real analysis
        callAgentAPI('Emergency', context, 'Assess emergency response capabilities and resource allocation').then(apiResult => {
          addActivityItem('Emergency Agent', `API Analysis: ${apiResult.substring(0, 100)}...`, 'normal');
        });
        
        return {
          incidentLoad: active > 5 ? 'heavy' : active > 2 ? 'moderate' : 'light',
          responseStatus: responseTime > 5 ? 'delayed' : 'optimal',
          resourceStatus: 'adequate'
        };
      }
      
      decide(analysis) {
        const decisions = [];
        if (analysis.incidentLoad === 'heavy') {
          decisions.push({ action: 'request_backup', reason: 'Heavy incident load', priority: 'high' });
        }
        if (analysis.responseStatus === 'delayed') {
          decisions.push({ action: 'optimize_routes', reason: 'Response times elevated', priority: 'high' });
        }
        return decisions;
      }
    }
    
    class CitizenAgent extends Agent {
      constructor() {
        super('Citizen Agent', 'citizen');
      }
      
      analyze(context) {
        const sentiment = context.citizen?.sentiment || 78;
        const complaints = context.citizen?.complaints || 147;
        
        // Call API for real analysis
        callAgentAPI('Citizen', context, 'Analyze citizen sentiment and complaint patterns').then(apiResult => {
          addActivityItem('Citizen Agent', `API Analysis: ${apiResult.substring(0, 100)}...`, 'normal');
        });
        
        return {
          sentimentStatus: sentiment > 70 ? 'positive' : sentiment > 50 ? 'neutral' : 'negative',
          complaintTrend: complaints > 150 ? 'increasing' : 'stable',
          topIssues: cityStateManager.shortTermState.citizen.topCategories
        };
      }
      
      decide(analysis) {
        const decisions = [];
        if (analysis.sentimentStatus === 'negative') {
          decisions.push({ action: 'alert_admin', reason: 'Negative citizen sentiment', priority: 'medium' });
        }
        if (analysis.complaintTrend === 'increasing') {
          decisions.push({ action: 'escalate_issues', reason: 'Rising complaint volume', priority: 'medium' });
        }
        return decisions;
      }
    }
    
    class CoordinatorAgent extends Agent {
      constructor(agents) {
        super('Coordinator', 'coordinator');
        this.agents = agents;
      }
      
      orchestrate() {
        const context = cityStateManager.getCompressedContext();
        const allDecisions = [];
        
        // Call API for coordination analysis
        callAgentAPI('Coordinator', context, 'Coordinate all city agents and resolve conflicts').then(apiResult => {
          addActivityItem('Coordinator', `API Coordination: ${apiResult.substring(0, 100)}...`, 'high');
        });
        
        for (const agent of this.agents) {
          const analysis = agent.analyze(context);
          const decisions = agent.decide(analysis);
          decisions.forEach(d => {
            d.agent = agent.name;
            allDecisions.push(d);
          });
        }
        
        // Resolve conflicts
        const finalDecisions = this.resolveConflicts(allDecisions);
        return finalDecisions;
      }
      
      resolveConflicts(decisions) {
        // Priority order: Emergency > Energy > Traffic > Citizen
        const priorityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
        
        return decisions.sort((a, b) => {
          const aPriority = priorityOrder[a.priority] || 0;
          const bPriority = priorityOrder[b.priority] || 0;
          return bPriority - aPriority;
        });
      }
    }
    
    // Initialize agents
    const trafficAgent = new TrafficAgent();
    const energyAgent = new EnergyAgent();
    const emergencyAgent = new EmergencyAgent();
    const citizenAgent = new CitizenAgent();
    const coordinatorAgent = new CoordinatorAgent([trafficAgent, energyAgent, emergencyAgent, citizenAgent]);
    
    // ==================== UI HELPERS ====================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      const colors = {
        info: 'bg-[#00ff88]/20 border-[#00ff88]/50 text-[#00ff88]',
        warning: 'bg-yellow-500/20 border-yellow-500/50 text-yellow-400',
        error: 'bg-red-500/20 border-red-500/50 text-red-400',
        success: 'bg-green-500/20 border-green-500/50 text-green-400'
      };
      
      toast.className = `px-4 py-3 rounded-lg border ${colors[type]} text-sm animate-[slideIn_0.3s_ease-out]`;
      toast.textContent = message;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'all 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function updateClock() {
      const now = new Date();
      document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour12: false });
      document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }
    
    function addActivityItem(agent, action, priority = 'normal') {
      const feed = document.getElementById('activity-feed');
      const item = document.createElement('div');
      
      const priorityColors = {
        critical: 'border-red-500/50 bg-red-500/10',
        high: 'border-yellow-500/50 bg-yellow-500/10',
        medium: 'border-blue-500/50 bg-blue-500/10',
        normal: 'border-gray-700 bg-[#0a0a0a]'
      };
      
      const agentIcons = {
        'Traffic Agent': 'ðŸš¦',
        'Energy Agent': 'âš¡',
        'Emergency Agent': 'ðŸš¨',
        'Citizen Agent': 'ðŸ‘¥',
        'Coordinator': 'ðŸ§ '
      };
      
      item.className = `p-2 rounded-lg border ${priorityColors[priority]} text-xs chat-message`;
      item.innerHTML = `
        <div class="flex items-center gap-2">
          <span>${agentIcons[agent] || 'ðŸ“Œ'}</span>
          <span class="font-medium">${agent}</span>
          <span class="text-gray-500 ml-auto">${new Date().toLocaleTimeString()}</span>
        </div>
        <p class="mt-1 text-gray-300">${action}</p>
      `;
      
      feed.insertBefore(item, feed.firstChild);
      
      // Keep only last 20 items
      while (feed.children.length > 20) {
        feed.removeChild(feed.lastChild);
      }
    }
    
    function addDecision(decision) {
      const list = document.getElementById('decisions-list');
      const item = document.createElement('div');
      
      const priorityBadges = {
        critical: 'bg-red-500/20 text-red-400',
        high: 'bg-yellow-500/20 text-yellow-400',
        medium: 'bg-blue-500/20 text-blue-400',
        low: 'bg-gray-500/20 text-gray-400'
      };
      
      item.className = 'p-3 bg-[#0a0a0a] rounded-lg chat-message';
      item.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-xs font-medium">${decision.agent}</span>
          <span class="text-xs px-2 py-0.5 rounded ${priorityBadges[decision.priority]}">${decision.priority}</span>
        </div>
        <p class="text-sm">${decision.action.replace(/_/g, ' ')}</p>
        <p class="text-xs text-gray-500 mt-1">${decision.reason}</p>
      `;
      
      list.insertBefore(item, list.firstChild);
      
      while (list.children.length > 10) {
        list.removeChild(list.lastChild);
      }
    }
    
    // ==================== CHAT INTERFACE ====================
    const chatResponses = {
      'city status': () => {
        const ctx = cityStateManager.getCompressedContext();
        return `**City Status Report**\n\nðŸš¦ Traffic: ${ctx.traffic.flow}% optimal flow, ${ctx.traffic.congestion} congestion points\nâš¡ Energy: ${ctx.energy.load} GW load, peak forecast ${ctx.energy.peak} GW\nðŸš¨ Emergencies: ${ctx.emergency.active} active incidents, avg response ${ctx.emergency.response} min\nðŸ‘¥ Citizens: ${ctx.citizen.sentiment}% positive sentiment, ${ctx.citizen.complaints} complaints today`;
      },
      'traffic report': () => {
        const state = cityStateManager.shortTermState.traffic;
        return `**Traffic Report**\n\nCurrent flow rate: ${state.flowRate}%\nCongestion points: ${state.congestionPoints.length}\nActive incidents: ${state.incidents.length}\n\nAll major intersections operational. Downtown experiencing moderate congestion.`;
      },
      'energy forecast': () => {
        const state = cityStateManager.shortTermState.energy;
        return `**Energy Forecast**\n\nCurrent load: ${state.currentLoad} GW\nPeak forecast: ${state.peakForecast} GW (expected 18:00)\nAnomalies detected: ${state.anomalies.length}\n\nGrid operating within normal parameters. Industrial zone showing slight spike.`;
      },
      'active emergencies': () => {
        const state = cityStateManager.shortTermState.emergency;
        return `**Active Emergencies**\n\nTotal incidents: ${state.activeIncidents}\n- Minor: 2\n- Critical: 1\n\nUnits available:\nðŸš’ Fire: ${state.units.fire}\nðŸš” Police: ${state.units.police}\nðŸš‘ EMS: ${state.units.ems}`;
      },
      'daily summary': () => {
        const ctx = cityStateManager.getCompressedContext();
        return `**Daily City Summary**\n\nðŸ“Š Overall Status: OPERATIONAL\n\nðŸš¦ Traffic: Good (${ctx.traffic.flow}% flow)\nâš¡ Energy: Normal (${ctx.energy.load} GW)\nðŸš¨ Response: Optimal (${ctx.emergency.response} min avg)\nðŸ‘¥ Sentiment: Positive (${ctx.citizen.sentiment}%)\n\nKey highlights:\n- 12 traffic signals optimized today\n- Energy peak managed successfully\n- All emergency responses within target time`;
      }
    };
    
    function processChat(input) {
      const normalizedInput = input.toLowerCase().trim();
      
      // Check if input is JSON data that needs formatting
      if (input.trim().startsWith('{') && input.trim().endsWith('}')) {
        try {
          const jsonData = JSON.parse(input);
          if (jsonData.timestamp && (jsonData.traffic || jsonData.energy)) {
            return Promise.resolve(formatCityStatus(jsonData));
          }
        } catch (e) {
          // Not valid JSON, continue with normal processing
        }
      }
      
      // Use API for chat responses
      const cityState = cityStateManager.getCompressedContext();
      return callChatAPI(input, cityState);
    }
    
    function addChatMessage(content, isUser = false) {
      const messages = document.getElementById('chat-messages');
      const wrapper = document.createElement('div');
      wrapper.className = `chat-message flex gap-3 ${isUser ? 'flex-row-reverse' : ''}`;
      
      if (isUser) {
        wrapper.innerHTML = `
          <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          <div class="flex-1 text-right">
            <div class="inline-block bg-purple-500/20 rounded-lg p-3 border border-purple-500/30 text-left">
              <p class="text-sm">${content}</p>
            </div>
          </div>
        `;
      } else {
        wrapper.innerHTML = `
          <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-[#00ff88] to-[#00d4ff] flex-shrink-0 flex items-center justify-center">
            <svg class="w-4 h-4 text-[#0a0a0a]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <div class="flex-1">
            <div class="bg-[#1a1a1a] rounded-lg p-3 border border-gray-800">
              <p class="text-sm whitespace-pre-line">${content}</p>
            </div>
          </div>
        `;
      }
      
      messages.appendChild(wrapper);
      messages.scrollTop = messages.scrollHeight;
      return wrapper;
    }
    
    // ==================== SIMULATIONS ====================
    function simulateEmergency() {
      showToast('ðŸš¨ Emergency simulation activated', 'warning');
      addActivityItem('Emergency Agent', 'Simulated emergency detected in Hospital District', 'critical');
      addActivityItem('Coordinator', 'Prioritizing emergency response routes', 'high');
      addActivityItem('Traffic Agent', 'Clearing routes for emergency vehicles', 'high');
      
      addDecision({
        agent: 'Emergency Agent',
        action: 'dispatch_units',
        reason: 'Simulated incident requires immediate response',
        priority: 'critical'
      });
      
      addDecision({
        agent: 'Traffic Agent',
        action: 'clear_routes',
        reason: 'Emergency vehicle routing priority',
        priority: 'high'
      });
      
      // Update emergency count
      cityStateManager.shortTermState.emergency.activeIncidents++;
      document.getElementById('emergency-value').textContent = cityStateManager.shortTermState.emergency.activeIncidents;
    }
    
    function simulateTrafficOptimization() {
      showToast('ðŸš¦ Traffic optimization started', 'info');
      addActivityItem('Traffic Agent', 'Analyzing congestion patterns across 847 intersections', 'medium');
      
      setTimeout(() => {
        addActivityItem('Traffic Agent', 'Adjusted signal timing at 12 intersections', 'normal');
        addDecision({
          agent: 'Traffic Agent',
          action: 'adjust_signals',
          reason: 'Optimized flow rate by 5%',
          priority: 'medium'
        });
        
        // Update traffic value
        const currentFlow = parseInt(document.getElementById('traffic-value').textContent);
        const newFlow = Math.min(95, currentFlow + 5);
        document.getElementById('traffic-value').textContent = `${newFlow}%`;
        document.getElementById('traffic-bar').style.width = `${newFlow}%`;
        
        showToast('Traffic flow improved by 5%', 'success');
      }, 1500);
    }
    
    function simulateEnergyBalance() {
      showToast('âš¡ Grid balancing initiated', 'info');
      addActivityItem('Energy Agent', 'Analyzing load distribution across substations', 'medium');
      
      setTimeout(() => {
        addActivityItem('Energy Agent', 'Load redistributed from Industrial to Commercial zone', 'normal');
        addDecision({
          agent: 'Energy Agent',
          action: 'load_balance',
          reason: 'Prevented potential overload in Industrial zone',
          priority: 'medium'
        });
        
        showToast('Grid balanced successfully', 'success');
      }, 1500);
    }
    
    function generateDailyReport() {
      showToast('ðŸ“Š Generating daily report', 'info');
      const report = chatResponses['daily summary']();
      addChatMessage(report, false);
      
      // Switch to chat tab
      document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.remove('active', 'border-[#00ff88]', 'text-[#00ff88]');
        t.classList.add('border-transparent', 'text-gray-400');
      });
      const chatTab = document.querySelector('[data-tab="chat"]');
      chatTab.classList.add('active', 'border-[#00ff88]', 'text-[#00ff88]');
      chatTab.classList.remove('border-transparent', 'text-gray-400');
      
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      document.getElementById('tab-chat').classList.remove('hidden');
    }
    
    // ==================== VOICE INTERFACE ====================
    let recognition = null;
    let isListening = false;
    
    function initVoice() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onresult = (event) => {
          const transcript = Array.from(event.results)
            .map(result => result[0].transcript)
            .join('');
          
          document.getElementById('voice-transcript').textContent = transcript;
          document.getElementById('modal-voice-transcript').textContent = transcript;
          
          if (event.results[0].isFinal) {
            stopListening();
            processVoiceCommand(transcript);
          }
        };
        
        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);
          stopListening();
          showToast('Voice recognition error. Please try again.', 'error');
        };
        
        recognition.onend = () => {
          stopListening();
        };
      }
    }
    
    function startListening() {
      if (!recognition) {
        showToast('Voice recognition not supported in this browser', 'error');
        return;
      }
      
      isListening = true;
      document.getElementById('voice-status').textContent = 'Listening...';
      document.getElementById('voice-button').classList.add('animate-pulse');
      document.getElementById('voice-modal').classList.remove('hidden');
      document.getElementById('modal-voice-status').textContent = 'Listening...';
      
      try {
        recognition.start();
      } catch (e) {
        console.error('Failed to start recognition:', e);
      }
    }
    
    function stopListening() {
      isListening = false;
      document.getElementById('voice-status').textContent = 'Click to speak';
      document.getElementById('voice-button').classList.remove('animate-pulse');
      document.getElementById('voice-modal').classList.add('hidden');
      
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          // Ignore
        }
      }
    }
    
    function processVoiceCommand(transcript) {
      addChatMessage(transcript, true);
      
      // Show processing indicator
      const processingMsg = addChatMessage('Processing voice command...', false);
      
      processChat(transcript).then(response => {
        processingMsg.remove();
        addChatMessage(response, false);
        
        // Speak response (first 200 characters)
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(response.substring(0, 200).replace(/\*\*/g, ''));
          utterance.rate = 1;
          utterance.pitch = 1;
          speechSynthesis.speak(utterance);
        }
      }).catch(err => {
        processingMsg.remove();
        addChatMessage('Sorry, I could not process your voice command.', false);
      });
      
      // Switch to chat tab
      document.querySelectorAll('.nav-tab').forEach(t => {
        t.classList.remove('active', 'border-[#00ff88]', 'text-[#00ff88]');
        t.classList.add('border-transparent', 'text-gray-400');
      });
      const chatTab = document.querySelector('[data-tab="chat"]');
      chatTab.classList.add('active', 'border-[#00ff88]', 'text-[#00ff88]');
      chatTab.classList.remove('border-transparent', 'text-gray-400');
      
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      document.getElementById('tab-chat').classList.remove('hidden');
    }
    
    // ==================== EVENT HANDLERS ====================
    function setupEventHandlers() {
      // Tab navigation
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.nav-tab').forEach(t => {
            t.classList.remove('active', 'border-[#00ff88]', 'text-[#00ff88]');
            t.classList.add('border-transparent', 'text-gray-400');
          });
          tab.classList.add('active', 'border-[#00ff88]', 'text-[#00ff88]');
          tab.classList.remove('border-transparent', 'text-gray-400');
          
          document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
          document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
        });
      });
      
      // Quick actions
      document.getElementById('btn-simulate-emergency').addEventListener('click', simulateEmergency);
      document.getElementById('btn-optimize-traffic').addEventListener('click', simulateTrafficOptimization);
      document.getElementById('btn-balance-energy').addEventListener('click', simulateEnergyBalance);
      document.getElementById('btn-daily-report').addEventListener('click', generateDailyReport);
      
      // Chat form
      document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (message) {
          addChatMessage(message, true);
          
          // Show typing indicator
          const typingMsg = addChatMessage('Thinking...', false);
          
          try {
            const response = await processChat(message);
            // Remove typing indicator
            typingMsg.remove();
            addChatMessage(response, false);
          } catch (err) {
            typingMsg.remove();
            addChatMessage('Sorry, I encountered an error processing your request.', false);
          }
          
          input.value = '';
        }
      });
      
      // Quick commands
      document.querySelectorAll('.quick-cmd').forEach(btn => {
        btn.addEventListener('click', async () => {
          const command = btn.textContent.trim();
          addChatMessage(command, true);
          
          // Show typing indicator
          const typingMsg = addChatMessage('Processing...', false);
          
          try {
            const response = await processChat(command);
            typingMsg.remove();
            addChatMessage(response, false);
          } catch (err) {
            typingMsg.remove();
            addChatMessage('Sorry, I encountered an error processing your request.', false);
          }
        });
      });
      
      // Clear chat
      document.getElementById('clear-chat').addEventListener('click', () => {
        const messages = document.getElementById('chat-messages');
        messages.innerHTML = '';
        showToast('Chat cleared', 'info');
      });
      
      // Voice controls
      document.getElementById('voice-button').addEventListener('click', () => {
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      });
      
      document.getElementById('voice-toggle').addEventListener('click', () => {
        if (isListening) {
          stopListening();
        } else {
          startListening();
        }
      });
      
      document.getElementById('close-voice-modal').addEventListener('click', stopListening);
    }
    
    // ==================== AGENT SIMULATION LOOP ====================
    function runAgentCycle() {
      const decisions = coordinatorAgent.orchestrate();
      
      if (decisions.length > 0 && Math.random() > 0.7) {
        const decision = decisions[Math.floor(Math.random() * decisions.length)];
        addDecision(decision);
        addActivityItem(decision.agent, decision.reason, decision.priority);
      }
    }
    
    // ==================== DATA SDK INTEGRATION ====================
    async function initDataSdk() {
      const dataHandler = {
        onDataChanged(data) {
          agentDecisions = data;
          // Update decisions display if needed
        }
      };
      
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }
    }
    
    async function saveDecision(decision) {
      if (window.dataSdk && agentDecisions.length < 999) {
        const result = await window.dataSdk.create({
          id: `decision-${Date.now()}`,
          type: 'decision',
          timestamp: new Date().toISOString(),
          agent: decision.agent,
          action: decision.action,
          priority: decision.priority,
          status: 'executed',
          details: decision.reason,
          compressed_context: JSON.stringify(cityStateManager.getCompressedContext())
        });
        
        if (!result.isOk) {
          console.error('Failed to save decision');
        }
      }
    }
    
    // ==================== ELEMENT SDK INTEGRATION ====================
    function initElementSdk() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            
            document.getElementById('city-name').textContent = config.city_name || defaultConfig.city_name;
            document.getElementById('dashboard-title').textContent = config.dashboard_title || defaultConfig.dashboard_title;
            
            document.body.style.backgroundColor = config.background_color || defaultConfig.background_color;
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              {
                get: () => cfg.background_color || defaultConfig.background_color,
                set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
              },
              {
                get: () => cfg.surface_color || defaultConfig.surface_color,
                set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
              },
              {
                get: () => cfg.text_color || defaultConfig.text_color,
                set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
              },
              {
                get: () => cfg.primary_action_color || defaultConfig.primary_action_color,
                set: (v) => { cfg.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); }
              },
              {
                get: () => cfg.secondary_action_color || defaultConfig.secondary_action_color,
                set: (v) => { cfg.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['city_name', cfg.city_name || defaultConfig.city_name],
            ['dashboard_title', cfg.dashboard_title || defaultConfig.dashboard_title]
          ])
        });
      }
    }
    
    // ==================== INITIALIZATION ====================
    async function init() {
      // Update clock
      updateClock();
      setInterval(updateClock, 1000);
      
      // Setup event handlers
      setupEventHandlers();
      
      // Initialize voice
      initVoice();
      
      // Initialize SDKs
      initElementSdk();
      await initDataSdk();
      
      // Start agent simulation loop
      setInterval(runAgentCycle, 5000);
      
      // Add initial activity
      addActivityItem('Coordinator', 'System initialized. All agents online.', 'normal');
      addActivityItem('Traffic Agent', 'Monitoring 847 intersections', 'normal');
      addActivityItem('Energy Agent', 'Grid status: nominal', 'normal');
      
      // Simulate some initial decisions
      setTimeout(() => {
        addDecision({
          agent: 'Traffic Agent',
          action: 'monitor_congestion',
          reason: 'Downtown area showing elevated traffic',
          priority: 'medium'
        });
      }, 2000);
      
      setTimeout(() => {
        addDecision({
          agent: 'Emergency Agent',
          action: 'standby_alert',
          reason: 'Active incident in Hospital District',
          priority: 'high'
        });
      }, 4000);
    }
    
    // Start the application
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c700b6033e079f2',t:'MTc2OTkzNDE4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>